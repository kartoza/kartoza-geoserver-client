version: "3.8"

services:
  # Iceberg REST Catalog - manages table metadata
  iceberg-rest:
    image: tabulario/iceberg-rest:1.5.0
    container_name: kartoza-iceberg-rest
    ports:
      - "8181:8181"
    environment:
      - CATALOG_WAREHOUSE=s3://warehouse/
      - CATALOG_IO__IMPL=org.apache.iceberg.aws.s3.S3FileIO
      - CATALOG_S3_ENDPOINT=http://minio:9000
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - AWS_REGION=us-east-1
    networks:
      - iceberg-net
    depends_on:
      - minio-setup
    healthcheck:
      test: ["CMD-SHELL", "(echo > /dev/tcp/localhost/8181) &>/dev/null && exit 0 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # MinIO - S3-compatible storage (can use existing MinIO or this one)
  minio:
    image: minio/minio:latest
    container_name: kartoza-iceberg-minio
    ports:
      - "9002:9000"     # S3 API (different port from main MinIO)
      - "9003:9001"     # Console (different port from main MinIO)
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - iceberg-minio-data:/data
    networks:
      - iceberg-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO setup - creates warehouse bucket
  minio-setup:
    image: minio/mc:latest
    container_name: kartoza-iceberg-minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set iceberg http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin};
      mc mb --ignore-existing iceberg/warehouse;
      mc policy set public iceberg/warehouse;
      echo 'Bucket setup complete';
      exit 0;
      "
    networks:
      - iceberg-net

  # Apache Sedona with Spark - for geospatial queries
  sedona-spark:
    image: apache/sedona:latest
    container_name: kartoza-sedona-spark
    ports:
      - "8888:8888"     # Jupyter
      - "8082:8080"     # Spark Master UI
      - "8083:8081"     # Spark Worker UI
      - "4040:4040"     # Spark Job UI
      - "10000:10000"   # Spark Thrift Server (for JDBC)
    environment:
      - DRIVER_MEM=4g
      - EXECUTOR_MEM=4g
      # Iceberg configuration
      - SPARK_CONF_spark_sql_extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions
      - SPARK_CONF_spark_sql_catalog_iceberg=org.apache.iceberg.spark.SparkCatalog
      - SPARK_CONF_spark_sql_catalog_iceberg_type=rest
      - SPARK_CONF_spark_sql_catalog_iceberg_uri=http://iceberg-rest:8181
      - SPARK_CONF_spark_sql_catalog_iceberg_io__impl=org.apache.iceberg.aws.s3.S3FileIO
      - SPARK_CONF_spark_sql_catalog_iceberg_warehouse=s3://warehouse/
      - SPARK_CONF_spark_sql_catalog_iceberg_s3_endpoint=http://minio:9000
      - SPARK_CONF_spark_sql_defaultCatalog=iceberg
      # S3/MinIO credentials
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER:-minioadmin}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - AWS_REGION=us-east-1
    volumes:
      - sedona-notebooks:/opt/notebooks
    networks:
      - iceberg-net
    depends_on:
      iceberg-rest:
        condition: service_healthy

networks:
  iceberg-net:
    driver: bridge

volumes:
  iceberg-minio-data:
    name: kartoza-iceberg-minio-data
  sedona-notebooks:
    name: kartoza-sedona-notebooks
