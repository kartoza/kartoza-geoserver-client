<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layer Preview - Kartoza GeoServer Client</title>

    <!-- MapLibre GL -->
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Kartoza brand colors */
            --kartoza-primary: #3B9DD9;
            --kartoza-primary-dark: #1B6B9B;
            --kartoza-primary-light: #5BB5E8;
            --kartoza-accent: #E8A331;
            --kartoza-accent-light: #F0B84D;

            /* Light theme backgrounds */
            --bg-primary: #f7f9fb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8ecf0;

            /* Text colors */
            --text-primary: #1a2a3a;
            --text-secondary: #4D6370;
            --text-muted: #6B7B8D;

            /* Semantic colors */
            --accent: #3B9DD9;
            --accent-hover: #1B6B9B;
            --success: #4CAF50;
            --warning: #E8A331;
            --error: #E55B3C;
            --border: #d4dbe2;

            /* Shadows */
            --shadow-sm: 0 2px 8px rgba(27, 107, 155, 0.08);
            --shadow-md: 0 4px 16px rgba(27, 107, 155, 0.12);
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 380px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -4px 0 16px rgba(27, 107, 155, 0.08);
        }

        .sidebar-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #1B6B9B 0%, #3B9DD9 100%);
            border-bottom: none;
        }

        .sidebar-header h1 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #ffffff;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--kartoza-primary);
            background: rgba(59, 157, 217, 0.05);
        }

        .tab.active {
            color: var(--kartoza-primary);
            border-bottom-color: var(--kartoza-primary);
            background: rgba(59, 157, 217, 0.08);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-item {
            background: var(--bg-primary);
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            transition: box-shadow 0.2s;
        }

        .info-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .info-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .info-value {
            font-size: 14px;
            color: var(--text-primary);
            word-break: break-all;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
            text-transform: uppercase;
        }

        .badge-vector {
            background: rgba(59, 157, 217, 0.15);
            color: var(--kartoza-primary-dark);
        }

        .badge-raster {
            background: rgba(76, 175, 80, 0.15);
            color: #2e7d32;
        }

        .attributes-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            border-radius: 10px;
            overflow: hidden;
        }

        .attributes-table th,
        .attributes-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .attributes-table th {
            background: var(--kartoza-primary);
            font-weight: 600;
            color: #ffffff;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .attributes-table tr:hover td {
            background: rgba(59, 157, 217, 0.05);
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--kartoza-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(229, 91, 60, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
        }

        .map-overlay {
            position: absolute;
            top: 16px;
            left: 16px;
            background: var(--bg-secondary);
            padding: 14px 18px;
            border-radius: 12px;
            border: none;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .map-overlay .layer-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--kartoza-primary-dark);
        }

        .map-overlay .workspace {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .map-overlay .status {
            font-size: 11px;
            color: var(--success);
            margin-top: 8px;
            font-weight: 500;
        }

        .map-overlay .status.loading {
            color: var(--kartoza-accent);
        }

        .map-overlay .status.error {
            color: var(--error);
        }

        .feature-popup {
            background: var(--bg-secondary);
            border: none;
            border-radius: 12px;
            padding: 14px;
            max-width: 300px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
        }

        .feature-popup h3 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--kartoza-primary-dark);
            padding-bottom: 8px;
            border-bottom: 2px solid var(--kartoza-primary);
        }

        .feature-popup .prop {
            margin-bottom: 8px;
        }

        .feature-popup .prop-name {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .feature-popup .prop-value {
            font-size: 13px;
            color: var(--text-primary);
        }

        .maplibregl-popup-content {
            background: var(--bg-secondary) !important;
            padding: 0 !important;
            border-radius: 12px !important;
            box-shadow: var(--shadow-md) !important;
        }

        .maplibregl-popup-tip {
            border-top-color: var(--bg-secondary) !important;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .capabilities-section {
            margin-bottom: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .capabilities-header {
            padding: 12px 16px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .capabilities-header:hover {
            background: rgba(59, 157, 217, 0.05);
        }

        .capabilities-header h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--kartoza-primary-dark);
            margin: 0;
        }

        .capabilities-header .toggle {
            font-size: 12px;
            color: var(--kartoza-primary);
        }

        .capabilities-body {
            padding: 14px;
        }

        .capabilities-body.collapsed {
            display: none;
        }

        .cap-item {
            margin-bottom: 12px;
        }

        .cap-item:last-child {
            margin-bottom: 0;
        }

        .cap-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .cap-value {
            font-size: 13px;
            color: var(--text-primary);
            word-break: break-all;
        }

        .cap-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cap-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .cap-list li:last-child {
            border-bottom: none;
        }

        .cap-code {
            background: var(--bg-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid var(--border);
        }

        .cap-badge {
            display: inline-block;
            padding: 3px 10px;
            font-size: 10px;
            font-weight: 600;
            border-radius: 12px;
            background: rgba(59, 157, 217, 0.12);
            color: var(--kartoza-primary-dark);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .coords-display {
            position: absolute;
            bottom: 30px;
            left: 16px;
            background: var(--bg-secondary);
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            box-shadow: var(--shadow-sm);
            font-size: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            color: var(--text-secondary);
            z-index: 1000;
        }

        .opacity-control {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .opacity-control label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .opacity-control input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        .opacity-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--kartoza-primary);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(59, 157, 217, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [layer, setLayer] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [activeTab, setActiveTab] = useState('info');
            const [features, setFeatures] = useState([]);
            const [coords, setCoords] = useState({ lng: 0, lat: 0 });
            const [layerStatus, setLayerStatus] = useState('loading');
            const [layerBounds, setLayerBounds] = useState(null);
            const [opacity, setOpacity] = useState(0.85);
            const [capabilities, setCapabilities] = useState(null);
            const [capabilitiesLoading, setCapabilitiesLoading] = useState(false);
            const [extendedMetadata, setExtendedMetadata] = useState(null);
            const [metadataLoading, setMetadataLoading] = useState(false);
            const [expandedSections, setExpandedSections] = useState({
                service: true,
                layer: true,
                formats: false,
                srs: false
            });
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);

            useEffect(() => {
                fetchLayerInfo();
            }, []);

            // Fetch extended metadata when layer is loaded
            useEffect(() => {
                if (layer && !extendedMetadata && !metadataLoading) {
                    fetchExtendedMetadata();
                }
            }, [layer]);

            // Zoom to layer extent when extended metadata is available
            useEffect(() => {
                if (extendedMetadata && mapInstanceRef.current) {
                    // Use latlon_bbox from REST API metadata (most reliable source)
                    const bbox = extendedMetadata.latlon_bbox;
                    console.log('Extended metadata latlon_bbox:', bbox);
                    if (bbox &&
                        (bbox.minx !== 0 || bbox.miny !== 0 || bbox.maxx !== 0 || bbox.maxy !== 0) &&
                        (bbox.minx !== bbox.maxx || bbox.miny !== bbox.maxy) &&
                        isFinite(bbox.minx) && isFinite(bbox.miny) && isFinite(bbox.maxx) && isFinite(bbox.maxy)) {
                        const bounds = [
                            [bbox.minx, bbox.miny],
                            [bbox.maxx, bbox.maxy]
                        ];
                        console.log('Zooming to bounds from REST API:', bounds);
                        setLayerBounds(bounds);
                        mapInstanceRef.current.fitBounds(bounds, { padding: 50, maxZoom: 18 });
                    }
                }
            }, [extendedMetadata]);

            useEffect(() => {
                if (layer && mapRef.current && !mapInstanceRef.current) {
                    initializeMap();
                }
            }, [layer]);

            const fetchLayerInfo = async () => {
                try {
                    const response = await fetch('/api/layer');
                    if (!response.ok) {
                        throw new Error('Failed to fetch layer info');
                    }
                    const data = await response.json();
                    setLayer(data);
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const fetchExtendedMetadata = async () => {
                setMetadataLoading(true);
                try {
                    const response = await fetch('/api/metadata');
                    if (response.ok) {
                        const data = await response.json();
                        setExtendedMetadata(data);
                    }
                } catch (err) {
                    console.error('Failed to fetch extended metadata:', err);
                } finally {
                    setMetadataLoading(false);
                }
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return null;
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleString();
                } catch {
                    return dateStr;
                }
            };

            const formatFilePath = (path) => {
                if (!path) return null;
                // Handle file:// URLs
                if (path.startsWith('file:')) {
                    return path.replace('file:', '');
                }
                return path;
            };

            const initializeMap = () => {
                const map = new maplibregl.Map({
                    container: mapRef.current,
                    style: {
                        version: 8,
                        sources: {
                            'osm': {
                                type: 'raster',
                                tiles: [
                                    'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
                                ],
                                tileSize: 256,
                                attribution: '&copy; OpenStreetMap contributors'
                            }
                        },
                        layers: [
                            {
                                id: 'osm-layer',
                                type: 'raster',
                                source: 'osm',
                                minzoom: 0,
                                maxzoom: 19
                            }
                        ]
                    },
                    center: [0, 0],
                    zoom: 2
                });

                map.addControl(new maplibregl.NavigationControl(), 'top-right');
                map.addControl(new maplibregl.ScaleControl(), 'bottom-right');

                map.on('mousemove', (e) => {
                    setCoords({ lng: e.lngLat.lng.toFixed(5), lat: e.lngLat.lat.toFixed(5) });
                });

                map.on('load', () => {
                    addGeoServerLayer(map);
                    fetchLayerBounds(map);
                });

                mapInstanceRef.current = map;
            };

            const addGeoServerLayer = (map) => {
                if (!layer) return;

                const layerName = `${layer.workspace}:${layer.name}`;
                // WMS URL - defined outside if/else so it's available for GetFeatureInfo
                const wmsUrl = `${layer.geoserver_url}/${layer.workspace}/wms`;

                let sourceConfig;
                let sourceId = 'geoserver-layer';
                let layerId = 'geoserver-wms';

                if (layer.use_cache) {
                    // Use WMTS (GeoWebCache) for cached tiles
                    const gridSet = layer.grid_set || 'EPSG:900913';
                    const tileFormat = layer.tile_format || 'image/png';

                    // GeoServer WMTS REST URL pattern
                    const wmtsUrl = `${layer.geoserver_url}/gwc/service/wmts/rest/${encodeURIComponent(layerName)}/${gridSet}/${encodeURIComponent(tileFormat)}/{z}/{y}/{x}`;

                    console.log('Using WMTS cache with URL pattern:', wmtsUrl);

                    sourceConfig = {
                        type: 'raster',
                        tiles: [wmtsUrl],
                        tileSize: 256
                    };
                    layerId = 'geoserver-wmts';
                } else {
                    // Use WMS (uncached)
                    sourceConfig = {
                        type: 'raster',
                        tiles: [
                            `${wmsUrl}?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=${encodeURIComponent(layerName)}&SRS=EPSG:3857&WIDTH=256&HEIGHT=256&BBOX={bbox-epsg-3857}`
                        ],
                        tileSize: 256
                    };
                }

                map.addSource(sourceId, sourceConfig);

                map.addLayer({
                    id: layerId,
                    type: 'raster',
                    source: sourceId,
                    paint: {
                        'raster-opacity': opacity
                    }
                });

                setLayerStatus('loaded');

                // Add click handler for GetFeatureInfo (vector layers only)
                map.on('click', async (e) => {
                    if (layer.type !== 'vector') return;

                    const point = map.project(e.lngLat);
                    const bbox = map.getBounds();
                    const width = map.getCanvas().width;
                    const height = map.getCanvas().height;

                    try {
                        const infoUrl = `${wmsUrl}?` + new URLSearchParams({
                            SERVICE: 'WMS',
                            VERSION: '1.1.1',
                            REQUEST: 'GetFeatureInfo',
                            LAYERS: layerName,
                            QUERY_LAYERS: layerName,
                            INFO_FORMAT: 'application/json',
                            X: Math.round(point.x),
                            Y: Math.round(point.y),
                            WIDTH: width,
                            HEIGHT: height,
                            BBOX: `${bbox.getWest()},${bbox.getSouth()},${bbox.getEast()},${bbox.getNorth()}`,
                            SRS: 'EPSG:4326'
                        });

                        const response = await fetch(infoUrl);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.features && data.features.length > 0) {
                                showPopup(map, e.lngLat, data.features[0]);
                            }
                        }
                    } catch (err) {
                        console.error('GetFeatureInfo failed:', err);
                    }
                });
            };

            const fetchLayerBounds = async (map) => {
                if (!layer) return;

                setLayerStatus('loading');
                const layerName = `${layer.workspace}:${layer.name}`;
                console.log('Fetching layer bounds for:', layerName);

                // Try WMS GetCapabilities first to get the layer bounding box
                try {
                    const wmsUrl = `${layer.geoserver_url}/${layer.workspace}/wms`;
                    const capsUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities`;
                    console.log('Fetching WMS capabilities from:', capsUrl);

                    const response = await fetch(capsUrl);
                    if (response.ok) {
                        const text = await response.text();
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(text, 'text/xml');

                        // Find the layer in capabilities
                        const layers = xml.querySelectorAll('Layer');
                        console.log('Found', layers.length, 'layers in capabilities');
                        for (const layerEl of layers) {
                            const nameEl = layerEl.querySelector('Name');
                            const foundName = nameEl?.textContent;
                            if (nameEl && (foundName === layer.name || foundName === layerName)) {
                                console.log('Found matching layer:', foundName);
                                // Try LatLonBoundingBox first (WMS 1.1.1)
                                const latLonBbox = layerEl.querySelector('LatLonBoundingBox');
                                if (latLonBbox) {
                                    const bounds = [
                                        [parseFloat(latLonBbox.getAttribute('minx')), parseFloat(latLonBbox.getAttribute('miny'))],
                                        [parseFloat(latLonBbox.getAttribute('maxx')), parseFloat(latLonBbox.getAttribute('maxy'))]
                                    ];
                                    console.log('Found LatLonBoundingBox, zooming to:', bounds);
                                    setLayerBounds(bounds);
                                    map.fitBounds(bounds, { padding: 50, maxZoom: 18 });
                                    setLayerStatus('loaded');
                                    return;
                                }

                                // Try BoundingBox with CRS:84 or EPSG:4326
                                const bboxes = layerEl.querySelectorAll('BoundingBox');
                                for (const bbox of bboxes) {
                                    const srs = bbox.getAttribute('SRS') || bbox.getAttribute('CRS');
                                    if (srs === 'EPSG:4326' || srs === 'CRS:84') {
                                        const bounds = [
                                            [parseFloat(bbox.getAttribute('minx')), parseFloat(bbox.getAttribute('miny'))],
                                            [parseFloat(bbox.getAttribute('maxx')), parseFloat(bbox.getAttribute('maxy'))]
                                        ];
                                        console.log('Found EPSG:4326 BoundingBox, zooming to:', bounds);
                                        setLayerBounds(bounds);
                                        map.fitBounds(bounds, { padding: 50, maxZoom: 18 });
                                        setLayerStatus('loaded');
                                        return;
                                    }
                                }
                                console.log('Layer found but no suitable bounding box');
                            }
                        }
                        console.log('Layer not found in capabilities, looked for:', layer.name, 'or', layerName);
                    }
                } catch (err) {
                    console.error('Failed to fetch WMS capabilities:', err);
                }

                // Fallback: try WFS for vector layers
                if (layer.type === 'vector') {
                    try {
                        const wfsUrl = `${layer.geoserver_url}/${layer.workspace}/wfs`;
                        const response = await fetch(
                            `${wfsUrl}?SERVICE=WFS&VERSION=2.0.0&REQUEST=GetFeature&TYPENAMES=${encodeURIComponent(layerName)}&COUNT=100&OUTPUTFORMAT=application/json`
                        );

                        if (response.ok) {
                            const data = await response.json();
                            if (data.features) {
                                setFeatures(data.features);

                                if (data.bbox) {
                                    const bounds = [
                                        [data.bbox[0], data.bbox[1]],
                                        [data.bbox[2], data.bbox[3]]
                                    ];
                                    setLayerBounds(bounds);
                                    map.fitBounds(bounds, { padding: 50, maxZoom: 18 });
                                } else if (data.features.length > 0) {
                                    const bounds = new maplibregl.LngLatBounds();
                                    data.features.forEach(f => {
                                        if (f.geometry && f.geometry.coordinates) {
                                            addCoordsTobound(bounds, f.geometry);
                                        }
                                    });
                                    if (!bounds.isEmpty()) {
                                        setLayerBounds([[bounds.getWest(), bounds.getSouth()], [bounds.getEast(), bounds.getNorth()]]);
                                        map.fitBounds(bounds, { padding: 50, maxZoom: 18 });
                                    }
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Failed to fetch WFS features:', err);
                    }
                }

                setLayerStatus('loaded');
            };

            const addCoordsTobound = (bounds, geometry) => {
                const processCoords = (coords) => {
                    if (typeof coords[0] === 'number' && coords.length >= 2) {
                        bounds.extend([coords[0], coords[1]]);
                    } else if (Array.isArray(coords)) {
                        coords.forEach(processCoords);
                    }
                };
                if (geometry.coordinates) {
                    processCoords(geometry.coordinates);
                }
            };

            const showPopup = (map, lngLat, feature) => {
                new maplibregl.Popup({ closeOnClick: true })
                    .setLngLat(lngLat)
                    .setHTML(createPopupContent(feature))
                    .addTo(map);
            };

            const createPopupContent = (feature) => {
                let html = '<div class="feature-popup">';
                html += `<h3>Feature ${feature.id || ''}</h3>`;

                if (feature.properties) {
                    Object.entries(feature.properties).forEach(([key, value]) => {
                        html += `<div class="prop">`;
                        html += `<div class="prop-name">${key}</div>`;
                        html += `<div class="prop-value">${value ?? 'null'}</div>`;
                        html += `</div>`;
                    });
                }

                html += '</div>';
                return html;
            };

            const handleOpacityChange = (e) => {
                const newOpacity = parseFloat(e.target.value);
                setOpacity(newOpacity);
                if (mapInstanceRef.current && mapInstanceRef.current.getLayer('geoserver-wms')) {
                    mapInstanceRef.current.setPaintProperty('geoserver-wms', 'raster-opacity', newOpacity);
                }
            };

            const zoomToLayer = () => {
                if (layerBounds && mapInstanceRef.current) {
                    mapInstanceRef.current.fitBounds(layerBounds, { padding: 50, maxZoom: 18 });
                }
            };

            const fetchCapabilities = async () => {
                if (!layer || capabilitiesLoading || capabilities) return;

                setCapabilitiesLoading(true);
                const layerName = `${layer.workspace}:${layer.name}`;

                try {
                    const wmsUrl = `${layer.geoserver_url}/${layer.workspace}/wms`;
                    const capsUrl = `${wmsUrl}?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities`;

                    const response = await fetch(capsUrl);
                    if (!response.ok) throw new Error('Failed to fetch capabilities');

                    const text = await response.text();
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(text, 'text/xml');

                    // Parse service information
                    const serviceInfo = {};
                    const service = xml.querySelector('Service');
                    if (service) {
                        serviceInfo.name = service.querySelector('Name')?.textContent || 'N/A';
                        serviceInfo.title = service.querySelector('Title')?.textContent || 'N/A';
                        serviceInfo.abstract = service.querySelector('Abstract')?.textContent || '';
                        serviceInfo.onlineResource = service.querySelector('OnlineResource')?.getAttribute('xlink:href') || '';

                        const keywords = service.querySelectorAll('KeywordList Keyword');
                        serviceInfo.keywords = Array.from(keywords).map(k => k.textContent);

                        const contactInfo = service.querySelector('ContactInformation');
                        if (contactInfo) {
                            serviceInfo.contactPerson = contactInfo.querySelector('ContactPersonPrimary ContactPerson')?.textContent || '';
                            serviceInfo.contactOrg = contactInfo.querySelector('ContactPersonPrimary ContactOrganization')?.textContent || '';
                            serviceInfo.contactEmail = contactInfo.querySelector('ContactElectronicMailAddress')?.textContent || '';
                        }
                    }

                    // Parse layer-specific information
                    const layerInfo = {};
                    const layers = xml.querySelectorAll('Layer');
                    for (const layerEl of layers) {
                        const nameEl = layerEl.querySelector('Name');
                        if (nameEl && (nameEl.textContent === layer.name || nameEl.textContent === layerName)) {
                            layerInfo.name = nameEl.textContent;
                            layerInfo.title = layerEl.querySelector('Title')?.textContent || layer.name;
                            layerInfo.abstract = layerEl.querySelector('Abstract')?.textContent || '';
                            layerInfo.queryable = layerEl.getAttribute('queryable') === '1';
                            layerInfo.opaque = layerEl.getAttribute('opaque') === '1';

                            // Get SRS list
                            const srsList = layerEl.querySelectorAll('SRS');
                            layerInfo.srs = Array.from(srsList).map(s => s.textContent);

                            // Get keywords
                            const keywords = layerEl.querySelectorAll('KeywordList Keyword');
                            layerInfo.keywords = Array.from(keywords).map(k => k.textContent);

                            // Get styles
                            const styles = layerEl.querySelectorAll('Style');
                            layerInfo.styles = Array.from(styles).map(s => ({
                                name: s.querySelector('Name')?.textContent || '',
                                title: s.querySelector('Title')?.textContent || '',
                                abstract: s.querySelector('Abstract')?.textContent || ''
                            }));

                            // Get bounding boxes
                            const latLonBbox = layerEl.querySelector('LatLonBoundingBox');
                            if (latLonBbox) {
                                layerInfo.latLonBbox = {
                                    minx: latLonBbox.getAttribute('minx'),
                                    miny: latLonBbox.getAttribute('miny'),
                                    maxx: latLonBbox.getAttribute('maxx'),
                                    maxy: latLonBbox.getAttribute('maxy')
                                };
                            }

                            // Get native bounding box
                            const bboxes = layerEl.querySelectorAll('BoundingBox');
                            layerInfo.boundingBoxes = Array.from(bboxes).map(b => ({
                                srs: b.getAttribute('SRS') || b.getAttribute('CRS'),
                                minx: b.getAttribute('minx'),
                                miny: b.getAttribute('miny'),
                                maxx: b.getAttribute('maxx'),
                                maxy: b.getAttribute('maxy')
                            }));

                            break;
                        }
                    }

                    // Parse supported formats
                    const capability = xml.querySelector('Capability');
                    const formats = {};
                    if (capability) {
                        const getMap = capability.querySelector('Request GetMap');
                        if (getMap) {
                            const formatEls = getMap.querySelectorAll('Format');
                            formats.getMap = Array.from(formatEls).map(f => f.textContent);
                        }

                        const getFeatureInfo = capability.querySelector('Request GetFeatureInfo');
                        if (getFeatureInfo) {
                            const formatEls = getFeatureInfo.querySelectorAll('Format');
                            formats.getFeatureInfo = Array.from(formatEls).map(f => f.textContent);
                        }
                    }

                    setCapabilities({ service: serviceInfo, layer: layerInfo, formats });
                } catch (err) {
                    console.error('Failed to parse capabilities:', err);
                    setCapabilities({ error: err.message });
                } finally {
                    setCapabilitiesLoading(false);
                }
            };

            const toggleSection = (section) => {
                setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
            };

            // Fetch capabilities when tab changes to 'capabilities'
            useEffect(() => {
                if (activeTab === 'capabilities' && layer && !capabilities) {
                    fetchCapabilities();
                }
            }, [activeTab, layer]);

            if (loading) {
                return (
                    <div className="app-container">
                        <div className="map-container" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div className="loading-spinner">
                                <div className="spinner"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="app-container">
                        <div className="map-container" style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                            <div className="error-message">{error}</div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="map-container">
                        <div ref={mapRef} id="map"></div>
                        {layer && (
                            <div className="map-overlay">
                                <div className="layer-name">{layer.name}</div>
                                <div className="workspace">{layer.workspace}</div>
                                {layer.use_cache && (
                                    <div style={{ marginTop: '4px' }}>
                                        <span className="badge badge-vector" style={{ fontSize: '10px' }}>WMTS Cache</span>
                                    </div>
                                )}
                                <div className={`status ${layerStatus}`}>
                                    {layerStatus === 'loading' ? 'Loading layer...' : (layer.use_cache ? 'Cached tiles loaded' : 'Layer loaded')}
                                </div>
                                <div className="opacity-control">
                                    <label>Layer Opacity: {Math.round(opacity * 100)}%</label>
                                    <input
                                        type="range"
                                        min="0"
                                        max="1"
                                        step="0.05"
                                        value={opacity}
                                        onChange={handleOpacityChange}
                                    />
                                </div>
                            </div>
                        )}
                        <div className="coords-display">
                            {coords.lng}, {coords.lat}
                        </div>
                    </div>

                    <div className="sidebar">
                        <div className="sidebar-header">
                            <h1>Layer Preview</h1>
                            <div className="subtitle">Kartoza GeoServer Client</div>
                        </div>

                        <div className="tabs">
                            <button
                                className={`tab ${activeTab === 'info' ? 'active' : ''}`}
                                onClick={() => setActiveTab('info')}
                            >
                                Metadata
                            </button>
                            <button
                                className={`tab ${activeTab === 'capabilities' ? 'active' : ''}`}
                                onClick={() => setActiveTab('capabilities')}
                            >
                                Capabilities
                            </button>
                            <button
                                className={`tab ${activeTab === 'attributes' ? 'active' : ''}`}
                                onClick={() => setActiveTab('attributes')}
                            >
                                Attributes
                            </button>
                        </div>

                        <div className="sidebar-content">
                            {activeTab === 'info' && layer && (
                                <div>
                                    <div className="section">
                                        <div className="section-title">Layer Information</div>
                                        <div className="info-grid">
                                            <div className="info-item">
                                                <div className="info-label">Name</div>
                                                <div className="info-value">{layer.name}</div>
                                            </div>
                                            {extendedMetadata?.layer_title && extendedMetadata.layer_title !== layer.name && (
                                                <div className="info-item">
                                                    <div className="info-label">Title</div>
                                                    <div className="info-value">{extendedMetadata.layer_title}</div>
                                                </div>
                                            )}
                                            <div className="info-item">
                                                <div className="info-label">Workspace</div>
                                                <div className="info-value">{layer.workspace}</div>
                                            </div>
                                            <div className="info-item">
                                                <div className="info-label">Store</div>
                                                <div className="info-value">{layer.store_name || 'N/A'}</div>
                                            </div>
                                            <div className="info-item">
                                                <div className="info-label">Type</div>
                                                <div className="info-value">
                                                    <span className={`badge ${layer.type === 'vector' ? 'badge-vector' : 'badge-raster'}`}>
                                                        {layer.type}
                                                    </span>
                                                </div>
                                            </div>
                                            {extendedMetadata?.layer_srs && (
                                                <div className="info-item">
                                                    <div className="info-label">Coordinate System</div>
                                                    <div className="info-value">{extendedMetadata.layer_srs}</div>
                                                </div>
                                            )}
                                            {extendedMetadata?.layer_default_style && (
                                                <div className="info-item">
                                                    <div className="info-label">Default Style</div>
                                                    <div className="info-value">{extendedMetadata.layer_default_style}</div>
                                                </div>
                                            )}
                                            {layerBounds && (
                                                <div className="info-item">
                                                    <div className="info-label">Bounding Box</div>
                                                    <div className="info-value" style={{ fontSize: '12px' }}>
                                                        {layerBounds[0][0].toFixed(4)}, {layerBounds[0][1].toFixed(4)}<br/>
                                                        {layerBounds[1][0].toFixed(4)}, {layerBounds[1][1].toFixed(4)}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        {extendedMetadata?.layer_abstract && (
                                            <div style={{ marginTop: '12px', padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                                <div className="info-label">Abstract</div>
                                                <div className="info-value" style={{ fontSize: '12px', lineHeight: '1.5' }}>{extendedMetadata.layer_abstract}</div>
                                            </div>
                                        )}
                                        {layerBounds && (
                                            <button
                                                onClick={zoomToLayer}
                                                style={{
                                                    marginTop: '12px',
                                                    padding: '8px 16px',
                                                    background: 'var(--accent)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    fontSize: '13px',
                                                    width: '100%'
                                                }}
                                            >
                                                Zoom to Layer Extent
                                            </button>
                                        )}
                                    </div>

                                    {/* Store / Data Source Information */}
                                    {extendedMetadata && (
                                        <div className="section">
                                            <div className="section-title">Data Source</div>
                                            <div className="info-grid">
                                                {extendedMetadata.store_format && (
                                                    <div className="info-item">
                                                        <div className="info-label">Format</div>
                                                        <div className="info-value">{extendedMetadata.store_format}</div>
                                                    </div>
                                                )}
                                                {extendedMetadata.coverage_native_format && (
                                                    <div className="info-item">
                                                        <div className="info-label">Native Format</div>
                                                        <div className="info-value">{extendedMetadata.coverage_native_format}</div>
                                                    </div>
                                                )}
                                                {formatFilePath(extendedMetadata.store_url) && (
                                                    <div className="info-item">
                                                        <div className="info-label">Server File Path</div>
                                                        <div className="info-value" style={{ fontSize: '11px', fontFamily: 'monospace' }}>
                                                            {formatFilePath(extendedMetadata.store_url)}
                                                        </div>
                                                    </div>
                                                )}
                                                <div className="info-item">
                                                    <div className="info-label">Store Enabled</div>
                                                    <div className="info-value">
                                                        <span className={`cap-badge ${extendedMetadata.store_enabled ? 'badge-vector' : ''}`}>
                                                            {extendedMetadata.store_enabled ? 'Yes' : 'No'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="info-item">
                                                    <div className="info-label">Layer Enabled</div>
                                                    <div className="info-value">
                                                        <span className={`cap-badge ${extendedMetadata.layer_enabled ? 'badge-vector' : ''}`}>
                                                            {extendedMetadata.layer_enabled ? 'Yes' : 'No'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="info-item">
                                                    <div className="info-label">Queryable</div>
                                                    <div className="info-value">
                                                        <span className={`cap-badge ${extendedMetadata.layer_queryable ? 'badge-vector' : ''}`}>
                                                            {extendedMetadata.layer_queryable ? 'Yes' : 'No'}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="info-item">
                                                    <div className="info-label">Advertised</div>
                                                    <div className="info-value">
                                                        <span className={`cap-badge ${extendedMetadata.layer_advertised ? 'badge-vector' : ''}`}>
                                                            {extendedMetadata.layer_advertised ? 'Yes' : 'No'}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {/* Timestamps */}
                                    {extendedMetadata && (extendedMetadata.date_created || extendedMetadata.date_modified) && (
                                        <div className="section">
                                            <div className="section-title">Timestamps</div>
                                            <div className="info-grid">
                                                {extendedMetadata.date_created && (
                                                    <div className="info-item">
                                                        <div className="info-label">Created</div>
                                                        <div className="info-value">{formatDate(extendedMetadata.date_created)}</div>
                                                    </div>
                                                )}
                                                {extendedMetadata.date_modified && (
                                                    <div className="info-item">
                                                        <div className="info-label">Modified</div>
                                                        <div className="info-value">{formatDate(extendedMetadata.date_modified)}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Coverage Dimensions (for raster) */}
                                    {extendedMetadata?.coverage_dimensions?.length > 0 && (
                                        <div className="section">
                                            <div className="section-title">Raster Bands</div>
                                            <div className="info-grid">
                                                <div className="info-item">
                                                    <div className="info-label">Dimensions</div>
                                                    <div className="info-value">
                                                        {extendedMetadata.coverage_dimensions.map((dim, idx) => (
                                                            <span key={idx} className="cap-badge">{dim}</span>
                                                        ))}
                                                    </div>
                                                </div>
                                                {extendedMetadata.coverage_interpolation && (
                                                    <div className="info-item">
                                                        <div className="info-label">Interpolation</div>
                                                        <div className="info-value">{extendedMetadata.coverage_interpolation}</div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* Keywords */}
                                    {extendedMetadata?.layer_keywords?.length > 0 && (
                                        <div className="section">
                                            <div className="section-title">Keywords</div>
                                            <div style={{ padding: '12px', background: 'var(--bg-tertiary)', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                                {extendedMetadata.layer_keywords.map((kw, idx) => (
                                                    <span key={idx} className="cap-badge">{kw}</span>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* Native Bounding Box */}
                                    {extendedMetadata?.native_bbox?.crs && (
                                        <div className="section">
                                            <div className="section-title">Native Bounding Box</div>
                                            <div className="info-grid">
                                                <div className="info-item">
                                                    <div className="info-label">CRS</div>
                                                    <div className="info-value">{extendedMetadata.native_bbox.crs}</div>
                                                </div>
                                                <div className="info-item">
                                                    <div className="info-label">Extent</div>
                                                    <div className="info-value" style={{ fontSize: '11px', fontFamily: 'monospace' }}>
                                                        {extendedMetadata.native_bbox.minx?.toFixed(2)}, {extendedMetadata.native_bbox.miny?.toFixed(2)}<br/>
                                                        {extendedMetadata.native_bbox.maxx?.toFixed(2)}, {extendedMetadata.native_bbox.maxy?.toFixed(2)}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <div className="section">
                                        <div className="section-title">GeoServer Endpoints</div>
                                        <div className="info-grid">
                                            <div className="info-item">
                                                <div className="info-label">GeoServer URL</div>
                                                <div className="info-value">{layer.geoserver_url}</div>
                                            </div>
                                            <div className="info-item">
                                                <div className="info-label">WMS Endpoint</div>
                                                <div className="info-value" style={{ fontSize: '11px' }}>{layer.geoserver_url}/{layer.workspace}/wms</div>
                                            </div>
                                            {layer.type === 'vector' && (
                                                <div className="info-item">
                                                    <div className="info-label">WFS Endpoint</div>
                                                    <div className="info-value" style={{ fontSize: '11px' }}>{layer.geoserver_url}/{layer.workspace}/wfs</div>
                                                </div>
                                            )}
                                            {layer.type === 'raster' && (
                                                <div className="info-item">
                                                    <div className="info-label">WCS Endpoint</div>
                                                    <div className="info-value" style={{ fontSize: '11px' }}>{layer.geoserver_url}/{layer.workspace}/wcs</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {metadataLoading && (
                                        <div className="section" style={{ textAlign: 'center', padding: '20px' }}>
                                            <div className="spinner" style={{ margin: '0 auto', width: '24px', height: '24px' }}></div>
                                            <div style={{ marginTop: '8px', fontSize: '12px', color: 'var(--text-secondary)' }}>Loading extended metadata...</div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'capabilities' && (
                                <div>
                                    {capabilitiesLoading ? (
                                        <div className="loading-spinner">
                                            <div className="spinner"></div>
                                        </div>
                                    ) : capabilities?.error ? (
                                        <div className="error-message">{capabilities.error}</div>
                                    ) : capabilities ? (
                                        <div>
                                            {/* Service Information */}
                                            <div className="capabilities-section">
                                                <div
                                                    className="capabilities-header"
                                                    onClick={() => toggleSection('service')}
                                                >
                                                    <h4>WMS Service Information</h4>
                                                    <span className="toggle">{expandedSections.service ? '' : ''}</span>
                                                </div>
                                                <div className={`capabilities-body ${expandedSections.service ? '' : 'collapsed'}`}>
                                                    <div className="cap-item">
                                                        <div className="cap-label">Service Name</div>
                                                        <div className="cap-value">{capabilities.service?.name || 'N/A'}</div>
                                                    </div>
                                                    <div className="cap-item">
                                                        <div className="cap-label">Title</div>
                                                        <div className="cap-value">{capabilities.service?.title || 'N/A'}</div>
                                                    </div>
                                                    {capabilities.service?.abstract && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Abstract</div>
                                                            <div className="cap-value" style={{ fontSize: '12px' }}>{capabilities.service.abstract}</div>
                                                        </div>
                                                    )}
                                                    {capabilities.service?.contactOrg && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Contact Organization</div>
                                                            <div className="cap-value">{capabilities.service.contactOrg}</div>
                                                        </div>
                                                    )}
                                                    {capabilities.service?.contactEmail && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Contact Email</div>
                                                            <div className="cap-value">{capabilities.service.contactEmail}</div>
                                                        </div>
                                                    )}
                                                    {capabilities.service?.keywords?.length > 0 && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Keywords</div>
                                                            <div className="cap-value">
                                                                {capabilities.service.keywords.map((kw, idx) => (
                                                                    <span key={idx} className="cap-badge">{kw}</span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Layer Information */}
                                            <div className="capabilities-section">
                                                <div
                                                    className="capabilities-header"
                                                    onClick={() => toggleSection('layer')}
                                                >
                                                    <h4>Layer Details</h4>
                                                    <span className="toggle">{expandedSections.layer ? '' : ''}</span>
                                                </div>
                                                <div className={`capabilities-body ${expandedSections.layer ? '' : 'collapsed'}`}>
                                                    <div className="cap-item">
                                                        <div className="cap-label">Layer Name</div>
                                                        <div className="cap-value">{capabilities.layer?.name || layer.name}</div>
                                                    </div>
                                                    <div className="cap-item">
                                                        <div className="cap-label">Title</div>
                                                        <div className="cap-value">{capabilities.layer?.title || 'N/A'}</div>
                                                    </div>
                                                    {capabilities.layer?.abstract && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Abstract</div>
                                                            <div className="cap-value" style={{ fontSize: '12px' }}>{capabilities.layer.abstract}</div>
                                                        </div>
                                                    )}
                                                    <div className="cap-item">
                                                        <div className="cap-label">Queryable</div>
                                                        <div className="cap-value">
                                                            <span className={`cap-badge ${capabilities.layer?.queryable ? 'badge-vector' : ''}`}>
                                                                {capabilities.layer?.queryable ? 'Yes' : 'No'}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    {capabilities.layer?.latLonBbox && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Lat/Lon Bounding Box</div>
                                                            <div className="cap-code">
                                                                MinX: {capabilities.layer.latLonBbox.minx}{'\n'}
                                                                MinY: {capabilities.layer.latLonBbox.miny}{'\n'}
                                                                MaxX: {capabilities.layer.latLonBbox.maxx}{'\n'}
                                                                MaxY: {capabilities.layer.latLonBbox.maxy}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {capabilities.layer?.styles?.length > 0 && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Available Styles</div>
                                                            <ul className="cap-list">
                                                                {capabilities.layer.styles.map((style, idx) => (
                                                                    <li key={idx}>
                                                                        <strong>{style.name}</strong>
                                                                        {style.title && style.title !== style.name && (
                                                                            <span style={{ color: 'var(--text-secondary)', marginLeft: '8px' }}>
                                                                                ({style.title})
                                                                            </span>
                                                                        )}
                                                                    </li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}
                                                    {capabilities.layer?.keywords?.length > 0 && (
                                                        <div className="cap-item">
                                                            <div className="cap-label">Keywords</div>
                                                            <div className="cap-value">
                                                                {capabilities.layer.keywords.map((kw, idx) => (
                                                                    <span key={idx} className="cap-badge">{kw}</span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Supported SRS */}
                                            {capabilities.layer?.srs?.length > 0 && (
                                                <div className="capabilities-section">
                                                    <div
                                                        className="capabilities-header"
                                                        onClick={() => toggleSection('srs')}
                                                    >
                                                        <h4>Supported Coordinate Systems ({capabilities.layer.srs.length})</h4>
                                                        <span className="toggle">{expandedSections.srs ? '' : ''}</span>
                                                    </div>
                                                    <div className={`capabilities-body ${expandedSections.srs ? '' : 'collapsed'}`}>
                                                        <div className="cap-value">
                                                            {capabilities.layer.srs.slice(0, 30).map((srs, idx) => (
                                                                <span key={idx} className="cap-badge">{srs}</span>
                                                            ))}
                                                            {capabilities.layer.srs.length > 30 && (
                                                                <span style={{ color: 'var(--text-secondary)', fontSize: '12px', display: 'block', marginTop: '8px' }}>
                                                                    ... and {capabilities.layer.srs.length - 30} more
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* Supported Formats */}
                                            {capabilities.formats && (
                                                <div className="capabilities-section">
                                                    <div
                                                        className="capabilities-header"
                                                        onClick={() => toggleSection('formats')}
                                                    >
                                                        <h4>Supported Output Formats</h4>
                                                        <span className="toggle">{expandedSections.formats ? '' : ''}</span>
                                                    </div>
                                                    <div className={`capabilities-body ${expandedSections.formats ? '' : 'collapsed'}`}>
                                                        {capabilities.formats.getMap?.length > 0 && (
                                                            <div className="cap-item">
                                                                <div className="cap-label">GetMap Formats</div>
                                                                <ul className="cap-list">
                                                                    {capabilities.formats.getMap.map((fmt, idx) => (
                                                                        <li key={idx}>{fmt}</li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        )}
                                                        {capabilities.formats.getFeatureInfo?.length > 0 && (
                                                            <div className="cap-item">
                                                                <div className="cap-label">GetFeatureInfo Formats</div>
                                                                <ul className="cap-list">
                                                                    {capabilities.formats.getFeatureInfo.map((fmt, idx) => (
                                                                        <li key={idx}>{fmt}</li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="empty-state">
                                            <div className="empty-state-icon"></div>
                                            <div>Loading capabilities...</div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'attributes' && (
                                <div>
                                    {features.length > 0 ? (
                                        <div>
                                            <div className="section-title">
                                                Features ({features.length}{features.length === 100 ? '+' : ''})
                                            </div>
                                            <div style={{ overflowX: 'auto' }}>
                                                <table className="attributes-table">
                                                    <thead>
                                                        <tr>
                                                            <th>ID</th>
                                                            {features[0]?.properties && Object.keys(features[0].properties).slice(0, 3).map(key => (
                                                                <th key={key}>{key}</th>
                                                            ))}
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {features.slice(0, 50).map((feature, idx) => (
                                                            <tr key={idx}>
                                                                <td>{feature.id || idx + 1}</td>
                                                                {feature.properties && Object.keys(features[0].properties).slice(0, 3).map(key => (
                                                                    <td key={key}>{String(feature.properties[key] ?? '')}</td>
                                                                ))}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="empty-state">
                                            <div className="empty-state-icon"></div>
                                            <div>No features loaded</div>
                                            <div style={{ fontSize: '12px', marginTop: '8px' }}>
                                                {layer?.type === 'raster'
                                                    ? 'Raster layers do not have attributes'
                                                    : 'Click on the map to query features'}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
